# This is an example .goreleaser.yml file with some sane defaults.
# Make sure to check the documentation at http://goreleaser.com
before:
  hooks:
    # You may remove this if you don't use go modules.
    - go mod tidy
    # - ./scripts/install-kcl-lsp-all.sh

# .goreleaser.yml
builds:
  - id: goreleaser-zig-cross-compilation-macos
    main: ./cmd/kcl/main.go
    binary: kcl
    goos:
      - darwin
    goarch:
      - amd64
      - arm64
    ldflags:
      - "-X kcl-lang.io/cli/pkg/version.version={{.Version}}"
    env:
    - CGO_ENABLED=1
    - >-
        {{- if eq .Os "darwin" }}
          {{- if eq .Arch "amd64"}}CC=zig c++ -target x86_64-macos-none -F{{ .Env.SDK_PATH }}/System/Library/Frameworks{{- end }}
          {{- if eq .Arch "arm64"}}CC=zig c++ -target aarch64-macos-none -F{{ .Env.SDK_PATH }}/System/Library/Frameworks{{- end }}
        {{- end }}

  - id: goreleaser-zig-cross-compilation-linux
    main: ./cmd/kcl/main.go
    binary: kcl
    goos:
      - linux
    goarch:
      - amd64
      - arm64
    ldflags:
      - "-X kcl-lang.io/cli/pkg/version.version={{.Version}}"
    env:
    - CGO_ENABLED=1
    - >-
        {{- if eq .Os "linux" }}
          {{- if eq .Arch "amd64" }}CC=zig c++ -target x86_64-linux-musl{{- end }}
          {{- if eq .Arch "arm64"}}CC=zig c++ -target aarch64-linux-musl{{- end }}
        {{- end }}

  - id: goreleaser-zig-cross-compilation-windows
    main: ./cmd/kcl/main.go
    binary: kcl
    goos:
    - windows
    goarch:
    - amd64
    ldflags:
      - "-X kcl-lang.io/cli/pkg/version.version={{.Version}}"
    env:
    - CGO_ENABLED=1
    - >-
        {{- if eq .Os "windows" }}
          {{- if eq .Arch "amd64" }}CC=zig c++ -target x86_64-windows-gnu{{- end }}
          {{- if eq .Arch "arm64"}}CC=zig c++ -target aarch64-windows-gnu{{- end }}
        {{- end }}

archives:
  - format: tar.gz
    # this name template makes the OS and Arch compatible with the results of uname.
    name_template: "kcl-v{{ .Version }}-{{ .Os }}-{{ .Arch }}"
    # use zip for windows archives
    format_overrides:
    - goos: windows
      format: zip

brews:
  - tap:
      owner: kcl-lang
      name: homebrew-tap
    name: kcl
    url_template: "https://github.com/kcl-lang/cli/releases/download/{{ .Tag }}/kcl-v{{ .Version }}-{{ .Os }}-{{ .Arch }}.tar.gz"
    download_strategy: CurlDownloadStrategy
    # Git author used to commit to the repository.
    # Defaults are shown.
    commit_author:
      name: GoReleaser Bot
      email: goreleaser@carlosbecker.com
    folder: HomebrewFormula
    homepage: "https://github.com/kcl-lang/kcl"
    description: "KCL Command Line Interface"
    dependencies:
      - name: "kcl-lsp"
    license: "Apache License"
    skip_upload: false
    test: |
      system "#{bin}/kcl version"

scoop:
  name: kcl
  url_template: "https://github.com/kcl-lang/cli/releases/download/{{ .Tag }}/kcl-v{{ .Version }}-{{ .Os }}-{{ .Arch }}.zip"
  bucket:
    owner: kcl-lang
    name: scoop-bucket
    branch: main
    token: "{{ .Env.GITHUB_TOKEN }}"
  folder: Scoops
  commit_author:
    name: goreleaserbot
    email: bot@goreleaser.com
  commit_msg_template: "Scoop update for kcl version {{ .Tag }}"
  homepage: "http://github.com/kcl-lang/kcl"
  description: "KCL Command Line Interface"
  license: Apache License 2.0
